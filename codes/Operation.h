#include "Interface.h"
#include "Control.h"

// Decralation of usefull variables
int service_cost, return_amount;
String services[] = {"Urination", "Defecation", "Shower", "Cancel"};

// Method to count coin pulse generated by ISR
void countPulseISR(){
  Serial.println("Coin inserted");
  pulse++;
  counter = 0;
}

// Method to provide change
void cashReturn(int amount){
  if(amount > 0){
    lcdPrint("Please wait:", "Returning...");
    delay(3e3);
  }
  
  float i=0;
  if(amount >= 200){
    i = amount/200;
    while(i >= 1){
      servoRotate(servo2);
      delay(1e3);
      i -= 1;
    }
    if(i!=0) servoRotate(servo1);
  }else if(amount >= 100){
    i = amount/100;
    while(i>=1){
      servoRotate(servo1);
      delay(1e3);
      i -= 1;
    }  
  }
}

// Method to control the whole operation
void operation(){
  while(true){
    counter++;
    coin_value = 0;
    if(counter >= 30 && pulse >= 1){
      Serial.println("Counter pulse coin detected");
      Serial.println("Pulse: " + String(pulse));
      
      if(pulse == 1) coin_value = 100;
      else if(pulse == 2) coin_value = 200;
      else if(pulse == 5) coin_value = 500;

      pulse = 0;
    }

    if(coin_value == 0)
      lcdPrint("Please", "Insert coin");
    else
      break;
  }

  Serial.println("Coin received successfull");
  lcdPrint("Amount received:", String(coin_value) + "Tsh."); delay(3e3);

  int i=0; confirm = false;
  while(!confirm){
    lcdPrint("Select service:", services[i]);
    if(digitalRead(btn2_pin) == LOW){
      delay(500);
      i++;
      if( i > 3 ) i = 0;
    }
  }

  // Assign the service cost
  if(i==0) service_cost=100;
  else if(i==1) service_cost=200;
  else if(i==2) service_cost=300;
  else if(i==3) {
    lcdPrint("Service canceled", ""); delay(3e3);
    service_cost=0;
  }

  return_amount = coin_value - service_cost;

  if(service_cost > coin_value){
    lcdPrint("Sorry:", "Low balance"); delay(3e3);
    cashReturn(coin_value);
  }else{
    lcdPrint("Return amount:", String(return_amount) + "Tsh."); delay(3e3);
    cashReturn(return_amount);
    digitalWrite(lock_pin, HIGH); 
    delay(5e3);
    digitalWrite(lock_pin, LOW);
    lcdPrint("SUCCESS", "...");  delay(3e3);
  }
  confirm = false;
}